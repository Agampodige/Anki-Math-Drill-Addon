<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Home Stats</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .home-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .home-stat-card { background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; }
        .home-stat-value { font-size: 2em; font-weight: bold; display: block; }
        .home-stat-label { color: #666; margin-top: 5px; }
        .home-stat-icon { font-size: 1.5em; margin-bottom: 10px; display: block; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Test Home Stats Loading</h1>
    <div id="status" class="status info">Initializing...</div>
    
    <button onclick="testLoadRealData()">Load Real Data</button>
    <button onclick="testLoadMockData()">Load Mock Data</button>
    <button onclick="clearData()">Clear Data</button>
    
    <!-- Home Stats Grid -->
    <section class="home-stats-grid">
        <div class="home-stat-card">
            <span class="home-stat-icon">ðŸŽ¯</span>
            <div class="home-stat-info">
                <span class="home-stat-value" id="homeStatTotalAttempts">0</span>
                <span class="home-stat-label">Problems</span>
            </div>
        </div>
        <div class="home-stat-card">
            <span class="home-stat-icon">ðŸŽ¯</span>
            <div class="home-stat-info">
                <span class="home-stat-value" id="homeStatAccuracy">0%</span>
                <span class="home-stat-label">Accuracy</span>
            </div>
        </div>
        <div class="home-stat-card">
            <span class="home-stat-icon">ðŸ”¥</span>
            <div class="home-stat-info">
                <span class="home-stat-value" id="homeStatStreak">0</span>
                <span class="home-stat-label">Day Streak</span>
            </div>
        </div>
    </section>

    <div id="debug-output"></div>

    <script>
        // Mock bridge for testing
        let pybridge = {
            sendMessage: function(message) {
                console.log('Mock bridge received:', message);
                const data = JSON.parse(message);
                
                if (data.type === 'get_attempts') {
                    // Simulate real data loading
                    setTimeout(() => {
                        const mockResponse = JSON.stringify({
                            type: 'get_attempts_response',
                            payload: { 
                                attempts: generateMockAttempts(150), // Generate 150 mock attempts
                                success: true 
                            }
                        });
                        handlePythonMessage(mockResponse);
                    }, 100);
                }
            }
        };
        
        let isConnected = true;
        
        function generateMockAttempts(count) {
            const attempts = [];
            const operations = ['addition', 'subtraction', 'multiplication', 'division', 'complex'];
            const now = new Date();
            
            for (let i = 0; i < count; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - Math.floor(Math.random() * 30)); // Random date within last 30 days
                
                attempts.push({
                    id: i + 1,
                    operation: operations[Math.floor(Math.random() * operations.length)],
                    digits: Math.floor(Math.random() * 3) + 1,
                    question: `Mock question ${i + 1}`,
                    userAnswer: Math.floor(Math.random() * 100),
                    correctAnswer: Math.floor(Math.random() * 100),
                    isCorrect: Math.random() > 0.3, // 70% accuracy
                    timeTaken: Math.random() * 20 + 2, // 2-22 seconds
                    timestamp: date.toISOString()
                });
            }
            
            return attempts;
        }
        
        function sendToPython(type, payload) {
            if (isConnected && pybridge) {
                const message = JSON.stringify({
                    type: type,
                    payload: payload
                });
                pybridge.sendMessage(message);
            } else {
                console.warn('Python bridge not connected');
            }
        }
        
        function handlePythonMessage(message) {
            try {
                const data = JSON.parse(message);
                const type = data.type;
                const payload = data.payload;

                switch (type) {
                    case 'get_attempts_response':
                        console.log('ðŸ“ˆ Received attempts data for home stats:', payload);
                        if (payload.attempts && Array.isArray(payload.attempts)) {
                            updateHomeStatsFromBackend(payload.attempts);
                            updateStatus('Real data loaded successfully!', 'success');
                        }
                        break;
                    default:
                        console.log('Unknown message type:', type);
                }
            } catch (e) {
                console.error('Error parsing message:', e);
                updateStatus('Error parsing message: ' + e.message, 'error');
            }
        }
        
        function updateHomeStatsFromBackend(attempts) {
            if (!attempts || !Array.isArray(attempts)) {
                console.error('Invalid attempts data received from backend');
                updateStatus('Invalid attempts data received', 'error');
                return;
            }

            const total = attempts.length;
            const correct = attempts.filter(a => a.isCorrect).length;
            const accuracy = Math.round((correct / total) * 100);

            // Calculate daily streak
            const dates = new Set();
            attempts.forEach(a => {
                const ts = a.timestamp || a.date;
                if (!ts) return;
                const d = typeof ts === 'number' ? new Date(ts * 1000) : new Date(ts);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                dates.add(dateStr);
            });

            let streak = 0;
            const today = new Date();
            const checkDate = new Date(today);

            while (true) {
                const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
                if (dates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            // Update the UI with real stats
            if (document.getElementById('homeStatTotalAttempts')) {
                document.getElementById('homeStatTotalAttempts').textContent = total;
                document.getElementById('homeStatAccuracy').textContent = accuracy + '%';
                document.getElementById('homeStatStreak').textContent = streak;
            }

            console.log(`Updated home stats with real data: ${total} attempts, ${accuracy}% accuracy, ${streak} day streak`);
            
            // Show debug info
            document.getElementById('debug-output').innerHTML = `
                <h3>Debug Info:</h3>
                <p><strong>Total Attempts:</strong> ${total}</p>
                <p><strong>Correct:</strong> ${correct}</p>
                <p><strong>Accuracy:</strong> ${accuracy}%</p>
                <p><strong>Daily Streak:</strong> ${streak}</p>
                <p><strong>Unique Dates:</strong> ${dates.size}</p>
                <p><strong>Date Range:</strong> ${Array.from(dates).sort().slice(0, 5).join(', ')}${dates.size > 5 ? '...' : ''}</p>
            `;
        }
        
        function testLoadRealData() {
            updateStatus('Loading real data from backend...', 'info');
            sendToPython('get_attempts', {});
        }
        
        function testLoadMockData() {
            updateStatus('Loading mock data...', 'info');
            const mockAttempts = generateMockAttempts(75);
            updateHomeStatsFromBackend(mockAttempts);
            updateStatus('Mock data loaded successfully!', 'success');
        }
        
        function clearData() {
            document.getElementById('homeStatTotalAttempts').textContent = '0';
            document.getElementById('homeStatAccuracy').textContent = '0%';
            document.getElementById('homeStatStreak').textContent = '0';
            document.getElementById('debug-output').innerHTML = '';
            updateStatus('Data cleared', 'info');
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Ready to test home stats loading', 'success');
        });
    </script>
</body>
</html>
