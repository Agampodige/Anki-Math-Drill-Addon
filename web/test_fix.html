<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #fafafa; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stat-card { text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; font-size: 14px; margin-top: 5px; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .loading { color: #3498db; text-align: center; padding: 20px; }
        .activity-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .mastery-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .mastery-cell { padding: 10px; text-align: center; border-radius: 4px; font-size: 12px; }
        .mastery-master { background: #f39c12; color: white; }
        .mastery-pro { background: #27ae60; color: white; }
        .mastery-apprentice { background: #3498db; color: white; }
        .mastery-novice { background: #95a5a6; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Progress Page Fix Test</h1>
        <p>This page tests the fix for loading real attempts data when Python bridge is not available.</p>
        
        <div class="card">
            <h2>Test Status</h2>
            <div id="testStatus" class="loading">‚è≥ Testing data loading...</div>
        </div>
        
        <div class="card">
            <h2>üìä Stats Overview</h2>
            <div id="statsOverview">
                <div class="loading">Loading stats...</div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìà Recent Activity</h2>
            <div id="recentActivity">
                <div class="loading">Loading activity...</div>
            </div>
        </div>
        
        <div class="card">
            <h2>üéØ Skills Mastery</h2>
            <div id="masteryGrid">
                <div class="loading">Loading mastery data...</div>
            </div>
        </div>
        
        <div class="card">
            <h2>üêõ Debug Info</h2>
            <pre id="debugInfo" style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">Loading debug info...</pre>
        </div>
    </div>

    <script>
        // Mock the progress page functionality
        class TestProgressPage {
            constructor() {
                this.progressData = {};
                this.testResults = [];
            }

            async loadRealData() {
                try {
                    console.log('üîÑ Loading real data from JSON file...');
                    this.addTestResult('Fetching attempts.json...', 'pending');
                    
                    // Try to fetch the attempts.json file
                    const response = await fetch('./attempts.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const attempts = await response.json();
                    this.addTestResult(`Loaded ${attempts.length} attempts from JSON`, 'success');
                    
                    // Calculate stats from real data
                    const totalAttempts = attempts.length;
                    const correctAttempts = attempts.filter(a => a.correct).length;
                    const accuracy = totalAttempts > 0 ? (correctAttempts / totalAttempts) * 100 : 0;
                    const totalTime = attempts.reduce((sum, a) => sum + (a.time_taken || 0), 0);
                    const avgSpeed = totalAttempts > 0 ? totalTime / totalAttempts : 0;
                    
                    this.addTestResult(`Calculated stats: ${totalAttempts} attempts, ${accuracy.toFixed(1)}% accuracy, ${avgSpeed.toFixed(2)}s avg speed`, 'success');
                    
                    // Group by date for recent activity
                    const dailyStats = {};
                    attempts.forEach(attempt => {
                        const date = attempt.created || attempt.timestamp?.split('T')[0];
                        if (date) {
                            if (!dailyStats[date]) {
                                dailyStats[date] = { count: 0, correct: 0, timeSum: 0 };
                            }
                            dailyStats[date].count++;
                            if (attempt.correct) dailyStats[date].correct++;
                            dailyStats[date].timeSum += attempt.time_taken || 0;
                        }
                    });
                    
                    this.addTestResult(`Grouped attempts by date: ${Object.keys(dailyStats).length} days`, 'success');
                    
                    // Create recent activity array
                    const recentActivity = Object.entries(dailyStats)
                        .sort(([a], [b]) => b.localeCompare(a))
                        .slice(0, 7)
                        .map(([date, stats]) => {
                            const today = new Date().toISOString().split('T')[0];
                            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                            
                            let timeAgo = date;
                            if (date === today) timeAgo = 'Today';
                            else if (date === yesterday) timeAgo = 'Yesterday';
                            else {
                                const days = Math.floor((new Date(today) - new Date(date)) / 86400000);
                                timeAgo = `${days} days ago`;
                            }
                            
                            return {
                                date,
                                timeAgo,
                                questions: stats.count,
                                accuracy: stats.count > 0 ? (stats.correct / stats.count) * 100 : 0,
                                avgSpeed: stats.count > 0 ? stats.timeSum / stats.count : 0
                            };
                        });
                    
                    // Create mastery data from real attempts
                    const mastery = {};
                    const operations = ['Addition', 'Subtraction', 'Multiplication', 'Division'];
                    operations.forEach(op => {
                        [1, 2, 3].forEach(digit => {
                            const opAttempts = attempts.filter(a => a.operation === op && a.digits === digit);
                            const correct = opAttempts.filter(a => a.correct).length;
                            const count = opAttempts.length;
                            const acc = count > 0 ? (correct / count) * 100 : 0;
                            const speed = count > 0 ? opAttempts.reduce((sum, a) => sum + (a.time_taken || 0), 0) / count : 0;
                            
                            let level = 'Novice';
                            if (acc >= 90 && speed < 3.0) level = 'Master';
                            else if (acc >= 80 && speed < 5.0) level = 'Pro';
                            else if (acc >= 70) level = 'Apprentice';
                            
                            mastery[`${op}-${digit}`] = { level, acc, speed, count };
                        });
                    });
                    
                    this.addTestResult(`Generated mastery data for ${operations.length} operations √ó 3 digits`, 'success');
                    
                    const realData = {
                        stats: {
                            totalQuestions: totalAttempts,
                            avgAccuracy: accuracy,
                            avgSpeed: avgSpeed,
                            currentStreak: 0,
                            practiceDays: Object.keys(dailyStats).length
                        },
                        recentActivity,
                        mastery,
                        chartData: recentActivity.slice(0, 7).reverse().map(activity => ({
                            label: new Date(activity.date).toLocaleDateString('en', { weekday: 'short' }),
                            accuracy: activity.accuracy,
                            speed: activity.avgSpeed
                        }))
                    };
                    
                    this.progressData = realData;
                    this.updateUI();
                    this.addTestResult('‚úÖ All data loaded successfully!', 'success');
                    
                    return realData;
                    
                } catch (error) {
                    console.error('‚ùå Error loading real data:', error);
                    this.addTestResult(`‚ùå Error: ${error.message}`, 'error');
                    throw error;
                }
            }

            addTestResult(message, status) {
                this.testResults.push({ message, status, timestamp: new Date().toLocaleTimeString() });
                this.updateTestStatus();
            }

            updateTestStatus() {
                const statusDiv = document.getElementById('testStatus');
                const latest = this.testResults[this.testResults.length - 1];
                if (latest) {
                    const icon = latest.status === 'success' ? '‚úÖ' : latest.status === 'error' ? '‚ùå' : '‚è≥';
                    const color = latest.status === 'success' ? 'success' : latest.status === 'error' ? 'error' : 'loading';
                    statusDiv.innerHTML = `<div class="${color}">${icon} ${latest.message}</div>`;
                }
            }

            updateUI() {
                // Update stats
                const statsOverview = document.getElementById('statsOverview');
                const stats = this.progressData.stats || {};
                statsOverview.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalQuestions || 0}</div>
                            <div class="stat-label">Questions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(stats.avgAccuracy || 0).toFixed(1)}%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(stats.avgSpeed || 0).toFixed(2)}s</div>
                            <div class="stat-label">Avg Speed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.practiceDays || 0}</div>
                            <div class="stat-label">Practice Days</div>
                        </div>
                    </div>
                `;
                
                // Update recent activity
                const recentActivity = document.getElementById('recentActivity');
                const activities = this.progressData.recentActivity || [];
                if (activities.length === 0) {
                    recentActivity.innerHTML = '<div class="loading">No recent activity found</div>';
                } else {
                    recentActivity.innerHTML = activities.map(item => `
                        <div class="activity-item">
                            <div>
                                <strong>${item.date}</strong> (${item.timeAgo})
                            </div>
                            <div>
                                ${item.questions} questions, ${item.accuracy.toFixed(1)}% accuracy, ${item.avgSpeed.toFixed(2)}s avg speed
                            </div>
                        </div>
                    `).join('');
                }
                
                // Update mastery grid
                const masteryGrid = document.getElementById('masteryGrid');
                const mastery = this.progressData.mastery || {};
                const operations = ['Addition', 'Subtraction', 'Multiplication', 'Division'];
                
                let masteryHTML = '<div class="mastery-grid">';
                operations.forEach(op => {
                    [1, 2, 3].forEach(digit => {
                        const key = `${op}-${digit}`;
                        const stats = mastery[key] || { level: 'Novice', acc: 0, speed: 0, count: 0 };
                        masteryHTML += `
                            <div class="mastery-cell mastery-${stats.level.toLowerCase()}">
                                <div><strong>${op}</strong></div>
                                <div>${digit}D</div>
                                <div>${stats.level}</div>
                                <div>${stats.acc.toFixed(0)}% | ${stats.speed.toFixed(1)}s</div>
                                <div>(${stats.count})</div>
                            </div>
                        `;
                    });
                });
                masteryHTML += '</div>';
                masteryGrid.innerHTML = masteryHTML;
                
                // Update debug info
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.textContent = JSON.stringify({
                    testResults: this.testResults,
                    dataSummary: {
                        totalAttempts: this.progressData.stats?.totalQuestions || 0,
                        recentActivityCount: (this.progressData.recentActivity || []).length,
                        masteryEntries: Object.keys(this.progressData.mastery || {}).length
                    },
                    sampleData: this.progressData
                }, null, 2);
            }
        }

        // Run the test
        window.addEventListener('load', async () => {
            const testPage = new TestProgressPage();
            try {
                await testPage.loadRealData();
            } catch (error) {
                console.error('Test failed:', error);
            }
        });
    </script>
</body>
</html>
