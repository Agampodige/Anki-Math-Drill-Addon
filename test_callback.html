<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Callback Fix</title>
</head>
<body>
    <h1>Test Callback Fix</h1>
    
    <div id="sessionCount">0</div>
    <div id="todayCount">0</div>
    <div id="lifetimeCount">0</div>
    <div id="statsDetail">Start answering to see stats</div>
    
    <button onclick="testStats()">Test Stats Update</button>
    <div id="result"></div>
    
    <script>
        // Mock Python bridge
        window.pythonBridge = {
            send: function(action, data, callbackId) {
                console.log('Mock bridge send:', action, data, callbackId);
                
                // Simulate Python response
                setTimeout(() => {
                    const mockStats = {
                        session: 5,
                        today: 12,
                        lifetime: 156,
                        accuracy: 85.5,
                        avgSpeed: 2.3,
                        totalTime: 27.6
                    };
                    
                    // Execute the callback directly (like our fixed Python bridge does)
                    if (this.callbacks && this.callbacks[callbackId]) {
                        console.log('Executing callback for:', callbackId);
                        this.callbacks[callbackId](mockStats);
                    }
                }, 100);
            },
            callbacks: {}
        };
        
        // Test function
        function testStats() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing...';
            
            // Simulate the updateStats call
            const callbackId = 'cb_test_' + Date.now();
            
            // Store callback
            window.pythonBridge.callbacks[callbackId] = function(stats) {
                console.log('Callback received stats:', stats);
                
                // Update UI
                document.getElementById('sessionCount').textContent = stats.session || 0;
                document.getElementById('todayCount').textContent = stats.today || 0;
                document.getElementById('lifetimeCount').textContent = stats.lifetime || 0;
                
                const statsDetail = document.getElementById('statsDetail');
                if (stats.today > 0) {
                    const accuracy = stats.accuracy || 0;
                    const avgSpeed = stats.avgSpeed || 0;
                    const totalTime = stats.totalTime || 0;
                    statsDetail.textContent = `Today: ${accuracy.toFixed(0)}% accuracy • ${avgSpeed.toFixed(2)}s avg • ${Math.floor(totalTime)}s total`;
                }
                
                resultDiv.innerHTML = '✅ Callback executed successfully! Stats updated.';
                
                // Clean up
                delete window.pythonBridge.callbacks[callbackId];
            };
            
            // Send request
            window.pythonBridge.send('get_stats', '{}', callbackId);
        }
    </script>
</body>
</html>
